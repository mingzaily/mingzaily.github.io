<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Php on 星河</title>
    <link>/tags/php/</link>
    <description>Recent content in Php on 星河</description>
    <generator>Hugo</generator>
    <language>zh-CN</language>
    <lastBuildDate>Mon, 30 Mar 2020 00:00:00 +0000</lastBuildDate>
    <atom:link href="/tags/php/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Laravel 契约和门面简单解读</title>
      <link>/post/2020/03/30/11/</link>
      <pubDate>Mon, 30 Mar 2020 00:00:00 +0000</pubDate>
      <guid>/post/2020/03/30/11/</guid>
      <description>&lt;p&gt;最近笔者正在理解Larvael服务容器、服务提供者、门面、契约的关系。&#xA;今天主要是记录自己借Laravel自带的Cache模块进行一个讲解。&lt;/p&gt;&#xA;&lt;h3 id=&#34;代码和流程&#34;&gt;代码和流程&lt;/h3&gt;&#xA;&lt;p&gt;首先我们打开&lt;code&gt;config\app.php&lt;/code&gt;中&lt;code&gt;providers&lt;/code&gt;下有一个服务提供者&lt;code&gt;Illuminate\Cache\CacheServiceProvider::class&lt;/code&gt;&lt;br&gt;&#xA;我们看看他的服务提供者是怎么写的：&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;public function register()&#xD;&#xA;    {&#xD;&#xA;        $this-&amp;gt;app-&amp;gt;singleton(&#39;cache&#39;, function ($app) {&#xD;&#xA;            return new CacheManager($app);&#xD;&#xA;        });&#xD;&#xA;&#xD;&#xA;        $this-&amp;gt;app-&amp;gt;singleton(&#39;cache.store&#39;, function ($app) {&#xD;&#xA;            return $app[&#39;cache&#39;]-&amp;gt;driver();&#xD;&#xA;        });&#xD;&#xA;&#xD;&#xA;        $this-&amp;gt;app-&amp;gt;singleton(&#39;cache.psr6&#39;, function ($app) {&#xD;&#xA;            return new Psr16Adapter($app[&#39;cache.store&#39;]);&#xD;&#xA;        });&#xD;&#xA;&#xD;&#xA;        $this-&amp;gt;app-&amp;gt;singleton(&#39;memcached.connector&#39;, function () {&#xD;&#xA;            return new MemcachedConnector;&#xD;&#xA;        });&#xD;&#xA;    }&#xD;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;我们主要看&lt;code&gt;cache&lt;/code&gt;这个门面，它所单例绑定的是&lt;code&gt;CacheManager&lt;/code&gt;，我们继续深入&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;&amp;lt;?php&#xD;&#xA;&#xD;&#xA;namespace Illuminate\Cache;&#xD;&#xA;&#xD;&#xA;use Aws\DynamoDb\DynamoDbClient;&#xD;&#xA;use Closure;&#xD;&#xA;use Illuminate\Contracts\Cache\Factory as FactoryContract;&#xD;&#xA;use Illuminate\Contracts\Cache\Store;&#xD;&#xA;use Illuminate\Contracts\Events\Dispatcher as DispatcherContract;&#xD;&#xA;use Illuminate\Support\Arr;&#xD;&#xA;use InvalidArgumentException;&#xD;&#xA;&#xD;&#xA;/**&#xD;&#xA; * @mixin \Illuminate\Contracts\Cache\Repository&#xD;&#xA; */&#xD;&#xA;class CacheManager implements FactoryContract&#xD;&#xA;{&#xD;&#xA;    /**&#xD;&#xA;     * The application instance.&#xD;&#xA;     *&#xD;&#xA;     * @var \Illuminate\Contracts\Foundation\Application&#xD;&#xA;     */&#xD;&#xA;    protected $app;&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * The array of resolved cache stores.&#xD;&#xA;     *&#xD;&#xA;     * @var array&#xD;&#xA;     */&#xD;&#xA;    protected $stores = [];&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * The registered custom driver creators.&#xD;&#xA;     *&#xD;&#xA;     * @var array&#xD;&#xA;     */&#xD;&#xA;    protected $customCreators = [];&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * Create a new Cache manager instance.&#xD;&#xA;     *&#xD;&#xA;     * @param  \Illuminate\Contracts\Foundation\Application  $app&#xD;&#xA;     * @return void&#xD;&#xA;     */&#xD;&#xA;    public function __construct($app)&#xD;&#xA;    {&#xD;&#xA;        $this-&amp;gt;app = $app;&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * Get a cache store instance by name, wrapped in a repository.&#xD;&#xA;     *&#xD;&#xA;     * @param  string|null  $name&#xD;&#xA;     * @return \Illuminate\Contracts\Cache\Repository&#xD;&#xA;     */&#xD;&#xA;    public function store($name = null)&#xD;&#xA;    {&#xD;&#xA;        $name = $name ?: $this-&amp;gt;getDefaultDriver();&#xD;&#xA;&#xD;&#xA;        return $this-&amp;gt;stores[$name] = $this-&amp;gt;get($name);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * Get a cache driver instance.&#xD;&#xA;     *&#xD;&#xA;     * @param  string|null  $driver&#xD;&#xA;     * @return \Illuminate\Contracts\Cache\Repository&#xD;&#xA;     */&#xD;&#xA;    public function driver($driver = null)&#xD;&#xA;    {&#xD;&#xA;        return $this-&amp;gt;store($driver);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * Attempt to get the store from the local cache.&#xD;&#xA;     *&#xD;&#xA;     * @param  string  $name&#xD;&#xA;     * @return \Illuminate\Contracts\Cache\Repository&#xD;&#xA;     */&#xD;&#xA;    protected function get($name)&#xD;&#xA;    {&#xD;&#xA;        return $this-&amp;gt;stores[$name] ?? $this-&amp;gt;resolve($name);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * Resolve the given store.&#xD;&#xA;     *&#xD;&#xA;     * @param  string  $name&#xD;&#xA;     * @return \Illuminate\Contracts\Cache\Repository&#xD;&#xA;     *&#xD;&#xA;     * @throws \InvalidArgumentException&#xD;&#xA;     */&#xD;&#xA;    protected function resolve($name)&#xD;&#xA;    {&#xD;&#xA;        $config = $this-&amp;gt;getConfig($name);&#xD;&#xA;&#xD;&#xA;        if (is_null($config)) {&#xD;&#xA;            throw new InvalidArgumentException(&amp;quot;Cache store [{$name}] is not defined.&amp;quot;);&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;        if (isset($this-&amp;gt;customCreators[$config[&#39;driver&#39;]])) {&#xD;&#xA;            return $this-&amp;gt;callCustomCreator($config);&#xD;&#xA;        } else {&#xD;&#xA;            $driverMethod = &#39;create&#39;.ucfirst($config[&#39;driver&#39;]).&#39;Driver&#39;;&#xD;&#xA;&#xD;&#xA;            if (method_exists($this, $driverMethod)) {&#xD;&#xA;                return $this-&amp;gt;{$driverMethod}($config);&#xD;&#xA;            } else {&#xD;&#xA;                throw new InvalidArgumentException(&amp;quot;Driver [{$config[&#39;driver&#39;]}] is not supported.&amp;quot;);&#xD;&#xA;            }&#xD;&#xA;        }&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * Call a custom driver creator.&#xD;&#xA;     *&#xD;&#xA;     * @param  array  $config&#xD;&#xA;     * @return mixed&#xD;&#xA;     */&#xD;&#xA;    protected function callCustomCreator(array $config)&#xD;&#xA;    {&#xD;&#xA;        return $this-&amp;gt;customCreators[$config[&#39;driver&#39;]]($this-&amp;gt;app, $config);&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    ......&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * Create an instance of the file cache driver.&#xD;&#xA;     *&#xD;&#xA;     * @param  array  $config&#xD;&#xA;     * @return \Illuminate\Cache\Repository&#xD;&#xA;     */&#xD;&#xA;    protected function createFileDriver(array $config)&#xD;&#xA;    {&#xD;&#xA;        return $this-&amp;gt;repository(new FileStore($this-&amp;gt;app[&#39;files&#39;], $config[&#39;path&#39;]));&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * Create a new cache repository with the given implementation.&#xD;&#xA;     *&#xD;&#xA;     * @param  \Illuminate\Contracts\Cache\Store  $store&#xD;&#xA;     * @return \Illuminate\Cache\Repository&#xD;&#xA;     */&#xD;&#xA;    public function repository(Store $store)&#xD;&#xA;    {&#xD;&#xA;        return tap(new Repository($store), function ($repository) {&#xD;&#xA;            $this-&amp;gt;setEventDispatcher($repository);&#xD;&#xA;        });&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * Set the event dispatcher on the given repository instance.&#xD;&#xA;     *&#xD;&#xA;     * @param  \Illuminate\Cache\Repository  $repository&#xD;&#xA;     * @return void&#xD;&#xA;     */&#xD;&#xA;    protected function setEventDispatcher(Repository $repository)&#xD;&#xA;    {&#xD;&#xA;        if (! $this-&amp;gt;app-&amp;gt;bound(DispatcherContract::class)) {&#xD;&#xA;            return;&#xD;&#xA;        }&#xD;&#xA;&#xD;&#xA;        $repository-&amp;gt;setEventDispatcher(&#xD;&#xA;            $this-&amp;gt;app[DispatcherContract::class]&#xD;&#xA;        );&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    ......&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * Get the cache connection configuration.&#xD;&#xA;     *&#xD;&#xA;     * @param  string  $name&#xD;&#xA;     * @return array&#xD;&#xA;     */&#xD;&#xA;    protected function getConfig($name)&#xD;&#xA;    {&#xD;&#xA;        return $this-&amp;gt;app[&#39;config&#39;][&amp;quot;cache.stores.{$name}&amp;quot;];&#xD;&#xA;    }&#xD;&#xA;&#xD;&#xA;    ......&#xD;&#xA;&#xD;&#xA;    /**&#xD;&#xA;     * Dynamically call the default driver instance.&#xD;&#xA;     *&#xD;&#xA;     * @param  string  $method&#xD;&#xA;     * @param  array  $parameters&#xD;&#xA;     * @return mixed&#xD;&#xA;     */&#xD;&#xA;    public function __call($method, $parameters)&#xD;&#xA;    {&#xD;&#xA;        return $this-&amp;gt;store()-&amp;gt;$method(...$parameters);&#xD;&#xA;    }&#xD;&#xA;}&#xD;&#xA;&#xD;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;我们以Laravel默认的File存储讲起：&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
