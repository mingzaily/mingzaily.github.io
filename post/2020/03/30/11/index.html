<!DOCTYPE html>
<html lang="zh-CN">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>Laravel 契约和门面简单解读 - 星河</title>
    <meta property="og:title" content="Laravel 契约和门面简单解读 - 星河">
    
    <meta name="twitter:card" content="summary">

    
    
      
    

    
      
      <meta property="description" content="最近笔者正在理解Larvael服务容器、服务提供者、门面、契约的关系。 今天主要是记录自己借Laravel自带的Cache模块进行一个讲解。
[&hellip;] 首先我们打开config\app.php中providers下有一个服务提供者Illuminate\Cache\CacheServiceProvider::class
我们看看他的服务提供者是怎么写的：
public function &amp;hellip;">
      <meta property="og:description" content="最近笔者正在理解Larvael服务容器、服务提供者、门面、契约的关系。 今天主要是记录自己借Laravel自带的Cache模块进行一个讲解。
[&hellip;] 首先我们打开config\app.php中providers下有一个服务提供者Illuminate\Cache\CacheServiceProvider::class
我们看看他的服务提供者是怎么写的：
public function &amp;hellip;">
      
    

    
    
    

    

    
    


<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/github.min.css">



    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <link rel="stylesheet" href="/css/diary.css" />
    
  </head>
  <body class="post">
    <header class="masthead">
      <h1><a href="/">星河</a></h1>

<p class="tagline">醉后不知天在水，满船清梦压星河</p>

      <nav class="menu">
  <input id="menu-check" type="checkbox" hidden/>
  <label id="menu-label" for="menu-check" class="unselectable" hidden>
    <span class="icon close-icon">✕</span>
    <span class="icon open-icon">☰</span>
    <span class="text">Menu</span>
  </label>
  <ul>
  
  
  <li><a href="/">首页</a></li>
  
  <li><a href="/shuoshuo">说说</a></li>
  
  <li><a href="/categories/">分类</a></li>
  
  <li><a href="/tags/">标签</a></li>
  
  <li><a href="/about/">关于</a></li>
  
  
  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
<h1>Laravel 契约和门面简单解读</h1>



<h3>

mingzaily






 / 
2020-03-30
</h3>

<hr>


      </header>





<p>最近笔者正在理解Larvael服务容器、服务提供者、门面、契约的关系。
今天主要是记录自己借Laravel自带的Cache模块进行一个讲解。</p>
<h3 id="代码和流程">代码和流程</h3>
<p>首先我们打开<code>config\app.php</code>中<code>providers</code>下有一个服务提供者<code>Illuminate\Cache\CacheServiceProvider::class</code><br>
我们看看他的服务提供者是怎么写的：</p>
<pre><code>public function register()
    {
        $this-&gt;app-&gt;singleton('cache', function ($app) {
            return new CacheManager($app);
        });

        $this-&gt;app-&gt;singleton('cache.store', function ($app) {
            return $app['cache']-&gt;driver();
        });

        $this-&gt;app-&gt;singleton('cache.psr6', function ($app) {
            return new Psr16Adapter($app['cache.store']);
        });

        $this-&gt;app-&gt;singleton('memcached.connector', function () {
            return new MemcachedConnector;
        });
    }
</code></pre>
<p>我们主要看<code>cache</code>这个门面，它所单例绑定的是<code>CacheManager</code>，我们继续深入</p>
<pre><code>&lt;?php

namespace Illuminate\Cache;

use Aws\DynamoDb\DynamoDbClient;
use Closure;
use Illuminate\Contracts\Cache\Factory as FactoryContract;
use Illuminate\Contracts\Cache\Store;
use Illuminate\Contracts\Events\Dispatcher as DispatcherContract;
use Illuminate\Support\Arr;
use InvalidArgumentException;

/**
 * @mixin \Illuminate\Contracts\Cache\Repository
 */
class CacheManager implements FactoryContract
{
    /**
     * The application instance.
     *
     * @var \Illuminate\Contracts\Foundation\Application
     */
    protected $app;

    /**
     * The array of resolved cache stores.
     *
     * @var array
     */
    protected $stores = [];

    /**
     * The registered custom driver creators.
     *
     * @var array
     */
    protected $customCreators = [];

    /**
     * Create a new Cache manager instance.
     *
     * @param  \Illuminate\Contracts\Foundation\Application  $app
     * @return void
     */
    public function __construct($app)
    {
        $this-&gt;app = $app;
    }

    /**
     * Get a cache store instance by name, wrapped in a repository.
     *
     * @param  string|null  $name
     * @return \Illuminate\Contracts\Cache\Repository
     */
    public function store($name = null)
    {
        $name = $name ?: $this-&gt;getDefaultDriver();

        return $this-&gt;stores[$name] = $this-&gt;get($name);
    }

    /**
     * Get a cache driver instance.
     *
     * @param  string|null  $driver
     * @return \Illuminate\Contracts\Cache\Repository
     */
    public function driver($driver = null)
    {
        return $this-&gt;store($driver);
    }

    /**
     * Attempt to get the store from the local cache.
     *
     * @param  string  $name
     * @return \Illuminate\Contracts\Cache\Repository
     */
    protected function get($name)
    {
        return $this-&gt;stores[$name] ?? $this-&gt;resolve($name);
    }

    /**
     * Resolve the given store.
     *
     * @param  string  $name
     * @return \Illuminate\Contracts\Cache\Repository
     *
     * @throws \InvalidArgumentException
     */
    protected function resolve($name)
    {
        $config = $this-&gt;getConfig($name);

        if (is_null($config)) {
            throw new InvalidArgumentException(&quot;Cache store [{$name}] is not defined.&quot;);
        }

        if (isset($this-&gt;customCreators[$config['driver']])) {
            return $this-&gt;callCustomCreator($config);
        } else {
            $driverMethod = 'create'.ucfirst($config['driver']).'Driver';

            if (method_exists($this, $driverMethod)) {
                return $this-&gt;{$driverMethod}($config);
            } else {
                throw new InvalidArgumentException(&quot;Driver [{$config['driver']}] is not supported.&quot;);
            }
        }
    }

    /**
     * Call a custom driver creator.
     *
     * @param  array  $config
     * @return mixed
     */
    protected function callCustomCreator(array $config)
    {
        return $this-&gt;customCreators[$config['driver']]($this-&gt;app, $config);
    }

    ......

    /**
     * Create an instance of the file cache driver.
     *
     * @param  array  $config
     * @return \Illuminate\Cache\Repository
     */
    protected function createFileDriver(array $config)
    {
        return $this-&gt;repository(new FileStore($this-&gt;app['files'], $config['path']));
    }

    /**
     * Create a new cache repository with the given implementation.
     *
     * @param  \Illuminate\Contracts\Cache\Store  $store
     * @return \Illuminate\Cache\Repository
     */
    public function repository(Store $store)
    {
        return tap(new Repository($store), function ($repository) {
            $this-&gt;setEventDispatcher($repository);
        });
    }

    /**
     * Set the event dispatcher on the given repository instance.
     *
     * @param  \Illuminate\Cache\Repository  $repository
     * @return void
     */
    protected function setEventDispatcher(Repository $repository)
    {
        if (! $this-&gt;app-&gt;bound(DispatcherContract::class)) {
            return;
        }

        $repository-&gt;setEventDispatcher(
            $this-&gt;app[DispatcherContract::class]
        );
    }

    ......

    /**
     * Get the cache connection configuration.
     *
     * @param  string  $name
     * @return array
     */
    protected function getConfig($name)
    {
        return $this-&gt;app['config'][&quot;cache.stores.{$name}&quot;];
    }

    ......

    /**
     * Dynamically call the default driver instance.
     *
     * @param  string  $method
     * @param  array  $parameters
     * @return mixed
     */
    public function __call($method, $parameters)
    {
        return $this-&gt;store()-&gt;$method(...$parameters);
    }
}

</code></pre>
<p>我们以Laravel默认的File存储讲起：</p>
<ol>
<li>当我们的控制器中使用<code>Cache::get()</code>,框架查找门面<code>Illuminate\Support\Facades\Cache</code>,返回一个叫<code>cache</code>的服务提供商</li>
<li>框架查找叫<code>cache</code>的服务提供商，实例化<code>CacheManager()</code></li>
<li>实例化<code>CacheManager</code>调用<code>get</code>方法,发现没有关于get的静态函数，于是触发了<code>__call</code>魔术方法</li>
<li><code>__call</code>调用函数<code>store</code></li>
</ol>
<ul>
<li><code>store</code>判断是否需要携带参数</li>
<li><code>get</code>方法判断是否需要从配置中读取，并进行<code>FileStore</code>的实例化，如果不需要直接返回<code>store[]</code>中的实例化过的<code>FileStore::class</code></li>
</ul>
<ol start="5">
<li><code>FileStore</code>实现了契约<code>Contracts\Cahce\Store</code></li>
<li><code>createXXXDriver</code>中发现返回的是<code>Cache\Repository</code>，并发现使用了<code>控制反转</code>，注入了不同的Store</li>
</ol>
<h3 id="总结">总结</h3>
<p>这样的设计控制器不需要去管理实现的是哪一种Cache，是file、redis还是memcached，同时<code>Cache\Repository</code>也规定了必须注入满足契约的实现类，规范整体设计和方法，上层无感知切换。</p>



  <footer>
  
  





















<script src="//cdn.jsdelivr.net/combine/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js,npm/@xiee/utils/js/load-highlight.js" defer></script>



  
  <hr>
  <div class="copyright">© <a href="https://mingzaily.com">mingzaily</a> 2019-2024 | <a href="https://github.com/mingzaily">Github</a></div>
  
  </footer>
  </article>
  
  </body>
</html>

