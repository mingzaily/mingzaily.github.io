<!doctype html><html lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Golang 简易WS服务 - 客户端 - 星河</title>
<meta property="og:title" content="Golang 简易WS服务 - 客户端 - 星河"><meta name=twitter:card content="summary"><meta property="description" content="客户端代码较为简单
"><meta property="og:description" content="客户端代码较为简单
"><link rel=stylesheet href=//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/github.min.css><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=/css/diary.css></head><body class=post><header class=masthead><h1><a href=/>星河</a></h1><p class=tagline>醉后不知天在水，满船清梦压星河</p><nav class=menu><input id=menu-check type=checkbox hidden>
<label id=menu-label for=menu-check class=unselectable hidden><span class="icon close-icon">✕</span>
<span class="icon open-icon">☰</span>
<span class=text>Menu</span></label><ul><li><a href=/>首页</a></li><li><a href=/shuoshuo>说说</a></li><li><a href=/categories/>分类</a></li><li><a href=/tags/>标签</a></li><li><a href=/about/>关于</a></li></ul></nav></header><article class=main><header class=title><h1>Golang 简易WS服务 - 客户端</h1><h3>mingzaily
/
2023-02-21</h3><hr></header><p>客户端代码较为简单</p><pre><code class=language-golang>
type SocketClient struct {
	host        string
	isClosed    chan bool
	log         *logger.Log // 自定义的log包
}

type wsMessage struct {
	Type int         `json:&quot;type&quot;`
	Data interface{} `json:&quot;data&quot;`
}

func NewSocketClient(configPath, logPath, host string) *SocketClient {
	w := io.MultiWriter(os.Stdout)
	if logPath != &quot;&quot; {
		f, err := util.OpenFile(logPath)
		if err != nil {
			panic(err)
		}
		w = io.MultiWriter(os.Stdout, f)
	}

	return &amp;SocketClient{
		host:        host,
		isClosed:    make(chan bool),
		log:         logger.New(w, logger.LINFO, log.LstdFlags|log.Lmsgprefix),
	}
}

func (s *SocketClient) Start() {
	// 设置在线
	ClientStatus = ClientStatusOnline

	// 连接服务器
	u := url.URL{Scheme: &quot;ws&quot;, Host: s.host, Path: &quot;/socket&quot;}
	s.log.Info(&quot;正在连接到&quot;, u.String())

	conn, _, err := websocket.DefaultDialer.Dial(u.String(), nil)
	if err != nil {
		s.log.ErrorF(&quot;连接到服务器错误: %v&quot;, err)
	}
	defer conn.Close()

	s.log.Info(&quot;已连接到服务器&quot;)

	interrupt := make(chan os.Signal, 1)

	// 监听中断信号
	signal.Notify(interrupt, syscall.SIGKILL, syscall.SIGINT, syscall.SIGTERM, os.Kill)
	// 心跳包
	go s.pingHandler(conn)
	// 接收消息
	go s.receiveHandler(conn)

	for {
		select {
		case &lt;-interrupt:
			s.log.Info(&quot;收到SIGINT中断信号，正在关闭ws连接。。。&quot;)
			_ = conn.WriteControl(websocket.CloseMessage, websocket.FormatCloseMessage(websocket.CloseNormalClosure, &quot;&quot;), time.Now().Add(time.Second))
			select {
			case &lt;-s.isClosed:
				s.log.Info(&quot;WS链接已关闭，退出中。。。&quot;)
			case &lt;-time.After(time.Duration(1) * time.Second):
				s.log.Info(&quot;关闭ws链接超时，退出中。。。&quot;)
			}
			return
		case &lt;-s.isClosed:
			s.log.Info(&quot;ws链接已关闭，退出中。。。&quot;)
			return
		}
	}
}

func (s *SocketClient) pingHandler(conn *websocket.Conn) {
	ticker := time.NewTicker(pingTime)
	for {
		select {
		case &lt;-ticker.C:
			status := strconv.FormatInt(int64(ClientStatus), 10)
			err := conn.WriteMessage(websocket.PingMessage, []byte(status))
			if err != nil {
				s.log.ErrorF(&quot;发送心跳包错误: %v&quot;, err)
				return
			}
		case &lt;-s.isClosed:
			return
		}
	}
}

func (s *SocketClient) receiveHandler(ws *websocket.Conn) {
	defer close(s.isClosed)
	for {
		messageType, message, err := ws.ReadMessage()
		if err != nil {
			s.log.ErrorF(&quot;读取消息 %v&quot;, err)
			return
		}
		switch messageType {
		case websocket.TextMessage:
			var textMessage *wsMessage

			err = json.Unmarshal(message, &amp;textMessage)
			if err != nil {
				s.log.ErrorF(&quot;消息格式错误: %v&quot;, err)
				break
			}

			switch textMessage.Type {
			        ...
			}
		}
	}
}

</code></pre><footer><script src=//cdn.jsdelivr.net/combine/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js,npm/@xiee/utils/js/load-highlight.js defer></script><hr><div class=copyright>© <a href=https://mingzaily.com>mingzaily</a> 2019-2024 | <a href=https://github.com/mingzaily>Github</a></div></footer></article></body></html>