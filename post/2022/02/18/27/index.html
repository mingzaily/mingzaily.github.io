<!DOCTYPE html>
<html lang="zh-CN">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <title>SQL提交规范 - 星河</title>
    <meta property="og:title" content="SQL提交规范 - 星河">
    
    <meta name="twitter:card" content="summary">

    
    
      
    

    
      
    

    
    
    

    

    
    


<link rel="stylesheet" href="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/github.min.css">



    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>
  <body class="post">
    <header class="masthead">
      <h1><a href="/">星河</a></h1>

<p class="tagline">醉后不知天在水，满船清梦压星河</p>

      <nav class="menu">
  <input id="menu-check" type="checkbox" hidden/>
  <label id="menu-label" for="menu-check" class="unselectable" hidden>
    <span class="icon close-icon">✕</span>
    <span class="icon open-icon">☰</span>
    <span class="text">Menu</span>
  </label>
  <ul>
  
  
  <li><a href="/">首页</a></li>
  
  <li><a href="/shuoshuo">说说</a></li>
  
  <li><a href="/categories/">分类</a></li>
  
  <li><a href="/tags/">标签</a></li>
  
  <li><a href="/about/">关于</a></li>
  
  
  </ul>
</nav>

    </header>

    <article class="main">
      <header class="title">
      
<h1>SQL提交规范</h1>



<h3>

mingzaily






 / 
2022-02-18
</h3>

<hr>


      </header>





<h4 id="规范">规范</h4>
<ol>
<li>插入数据不可重复，使用 <code>REPLACE INTO</code> 替代 <code>INSERT INTO</code>
<pre><code class="language-sql">REPLACE INTO tableName(columnName, ...) VALUES(...)
</code></pre>
</li>
<li>添加表时，使用 <code>IF NOT EXISTS</code>
<pre><code class="language-sql">CREATE TABLE IF NOT EXISTS XXX
</code></pre>
</li>
<li>删除表时，可以使用 <code>IF EXISTS</code>
<pre><code class="language-sql">DROP TABLE IF EXISTS XXX
</code></pre>
</li>
<li>管理字段和索引时，使用存储过程
<pre><code class="language-sql">CALL AddColumnIfNotExists ('ztc_room', 'introduction', 'VARCHAR(1000) NOT NULL DEFAULT \'\' COMMENT \'房源介绍\'');
</code></pre>
</li>
</ol>
<h4 id="常用存储过程">常用存储过程</h4>
<table>
  <thead>
      <tr>
          <th>过程名</th>
          <th>含义</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>AddColumnIfNotExists</td>
          <td>添加字段（表名，字段名，字段描述）</td>
      </tr>
      <tr>
          <td>UpdateColumnIfExists</td>
          <td>更新字段（表名，字段名，字段描述）</td>
      </tr>
      <tr>
          <td>DropColumnIfExists</td>
          <td>删除字段（表名，字段名）</td>
      </tr>
      <tr>
          <td>CreateIndexIfNotExists</td>
          <td>添加普通索引（表名，字段名）</td>
      </tr>
      <tr>
          <td>CreateUniqueIndexIfNotExists</td>
          <td>添加唯一索引（表名，字段名）</td>
      </tr>
      <tr>
          <td>CreateIndexIfNotExistsWithColumns</td>
          <td>添加组合普通索引（表名，索引名，字段名）</td>
      </tr>
      <tr>
          <td>CreateUniqueIndexIfNotExistsWithColumns</td>
          <td>添加组合唯一索引（表名，索引名，字段名）</td>
      </tr>
      <tr>
          <td>DropIndexIfExists</td>
          <td>删除索引（表名，索引名）</td>
      </tr>
  </tbody>
</table>
<pre><code>DELIMITER  $$
# AddColumnIfNotExists 添加字段
DROP
    PROCEDURE IF EXISTS AddColumnIfNotExists$$
CREATE PROCEDURE `AddColumnIfNotExists`(
    IN tableName varchar(100), IN columnName varchar(100),
    IN dbType varchar(100))
BEGIN
    DECLARE _tableCount INT;
    DECLARE _columnCount INT;

    SET
        _tableCount = (
            SELECT COUNT(1)
            FROM INFORMATION_SCHEMA.TABLES
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName);

    SET
        _columnCount = (
            SELECT COUNT(1)
            FROM INFORMATION_SCHEMA.COLUMNS
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName
            AND COLUMN_NAME = columnName);
    IF _tableCount = 1
        AND _columnCount = 0
    THEN
        SET
            @_sqlText = CONCAT(' ALTER TABLE `',
                            tableName, '` ADD COLUMN `',
                            columnName, '` ',
                            dbType);
        PREPARE stmt1
            FROM
            @_sqlText;
        EXECUTE stmt1;
        DEALLOCATE PREPARE stmt1;
    END IF;
END$$

# UpdateColumnIfExists 更新字段
DROP
    PROCEDURE IF EXISTS UpdateColumnIfExists$$
CREATE PROCEDURE `UpdateColumnIfExists`(
    IN tableName varchar(100), IN columnName varchar(100),
    IN dbType varchar(100))
BEGIN
    DECLARE _columnCount INT;

    SET
        _columnCount = (
            SELECT COUNT(1)
            FROM INFORMATION_SCHEMA.COLUMNS
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName
            AND COLUMN_NAME = columnName);
    IF
        _columnCount = 1 THEN
        SET
            @_sqlText = CONCAT(' ALTER TABLE `',
                            tableName, '` MODIFY COLUMN `',
                            columnName, '` ',
                            dbType
                );
        PREPARE stmt1
            FROM
            @_sqlText;
        EXECUTE stmt1; DEALLOCATE PREPARE stmt1;
    END IF;
END$$

# DropColumnIfExists 删除字段
DROP
    PROCEDURE IF EXISTS DropColumnIfExists$$
CREATE PROCEDURE `DropColumnIfExists`(
    IN tableName varchar(100), IN columnName varchar(100))
BEGIN
    DECLARE _columnCount INT;

    SET
        _columnCount = (
            SELECT COUNT(1)
            FROM INFORMATION_SCHEMA.COLUMNS
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName
            AND COLUMN_NAME = columnName);
    IF _columnCount = 1
    THEN
        SET
            @_sqlText = CONCAT(' ALTER TABLE ',
                            tableName, ' DROP COLUMN ',
                            columnName, ' ;'
                );
        PREPARE stmt1
            FROM
            @_sqlText;
        EXECUTE stmt1;
        DEALLOCATE PREPARE stmt1;
    END IF;
END$$

# CreateIndexIfNotExists 添加普通索引
DROP
    PROCEDURE IF EXISTS CreateIndexIfNotExists$$
CREATE PROCEDURE `CreateIndexIfNotExists`(
    IN tableName varchar(100), IN columnName varchar(100))
BEGIN
    DECLARE _tableCount INT;
    DECLARE _indexCount INT;

    SET
        _tableCount = (
            SELECT COUNT(1)
            FROM INFORMATION_SCHEMA.TABLES
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName);

    SET
        _indexCount = (
            SELECT COUNT(1)
            FROM information_schema.statistics
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName
            AND INDEX_NAME = CONCAT('IX_',
                                    columnName)
        );
    IF _tableCount = 1
        AND _indexCount = 0
    THEN
        SET
            @_sqlText = CONCAT(' CREATE INDEX `IX_',
                            columnName, '` ON `',
                            tableName, '`(`',
                            columnName, '` ASC);'
                );
        PREPARE stmt1
            FROM
            @_sqlText;
        EXECUTE stmt1; DEALLOCATE PREPARE stmt1;
    END IF;
END$$

# CreateUniqueIndexIfNotExists 添加唯一索引
DROP
    PROCEDURE IF EXISTS CreateUniqueIndexIfNotExists$$
CREATE PROCEDURE `CreateUniqueIndexIfNotExists`(
    IN tableName varchar(100), IN columnName varchar(100))
BEGIN
    DECLARE _tableCount INT;
    DECLARE _indexCount INT;

    SET
        _tableCount = (
            SELECT COUNT(1)
            FROM INFORMATION_SCHEMA.TABLES
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName);

    SET
        _indexCount = (
            SELECT COUNT(1)
            FROM information_schema.statistics
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName
            AND INDEX_NAME = CONCAT('IX_',
                                    columnName)
        );
    IF _tableCount = 1
        AND _indexCount = 0
    THEN
        SET
            @_sqlText = CONCAT(' CREATE UNIQUE INDEX `IX_',
                            columnName, '` ON `',
                            tableName, '`(`',
                            columnName, '` ASC);'
                );
        PREPARE stmt1
            FROM
            @_sqlText;
        EXECUTE stmt1; DEALLOCATE PREPARE stmt1;
    END IF;
END$$

# CreateIndexIfNotExistsWithColumns 添加组合普通索引
DROP
    PROCEDURE IF EXISTS CreateIndexIfNotExistsWithColumns$$
CREATE PROCEDURE `CreateIndexIfNotExistsWithColumns`(
    IN tableName varchar(200), IN indexName VARCHAR(200),
    IN columnName VARCHAR(200))
BEGIN
    DECLARE _tableCount INT;
    DECLARE _indexCount INT;

    SET
        _tableCount = (
            SELECT COUNT(1)
            FROM INFORMATION_SCHEMA.TABLES
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName);

    SET
        _indexCount = (
            SELECT COUNT(1)
            FROM information_schema.statistics
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName
            AND INDEX_NAME = CONCAT('IX_',
                                    indexName)
        );
    IF _tableCount = 1
        AND _indexCount = 0
    THEN
        SET
            @_sqlText = CONCAT(' CREATE INDEX `IX_',
                            indexName, '` ON `',
                            tableName, '`(',
                            columnName, ');
');
        PREPARE stmt1
            FROM
            @_sqlText;
        EXECUTE stmt1;
        DEALLOCATE PREPARE stmt1;
    END IF;
END$$

# CreateUniqueIndexIfNotExistsWithColumns 添加组合唯一索引
DROP
    PROCEDURE IF EXISTS CreateUniqueIndexIfNotExistsWithColumns$$
CREATE PROCEDURE `CreateUniqueIndexIfNotExistsWithColumns`(
    IN tableName VARCHAR(200), IN indexName VARCHAR(200),
    IN columnName VARCHAR(200))
BEGIN
    DECLARE _tableCount INT;
    DECLARE _indexCount INT;

    SET
        _tableCount = (
            SELECT COUNT(1)
            FROM INFORMATION_SCHEMA.TABLES
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName);

    SET
        _indexCount = (
            SELECT COUNT(1)
            FROM information_schema.statistics
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName
            AND INDEX_NAME = CONCAT('IX_',
                                    indexName)
        );
    IF _tableCount = 1
        AND _indexCount = 0
    THEN
        SET
            @_sqlText = CONCAT(' CREATE UNIQUE INDEX `IX_',
                            indexName, '` ON `',
                            tableName, '`(',
                            columnName, ');
');
        PREPARE stmt1
            FROM
            @_sqlText;
        EXECUTE stmt1;
        DEALLOCATE PREPARE stmt1;
    END IF;
END$$

# DropIndexIfExists 删除索引
DROP
    PROCEDURE IF EXISTS DropIndexIfExists$$
CREATE PROCEDURE `DropIndexIfExists`(
    IN tableName varchar(100), IN indexName varchar(100))
BEGIN
    DECLARE _indexCount INT;

    SET
        _indexCount = (
            SELECT COUNT(1)
            FROM information_schema.statistics
            WHERE TABLE_SCHEMA = (
                SELECT SCHEMA(
                        )
            )
            AND TABLE_NAME = tableName
            AND INDEX_NAME = CONCAT('IX_',
                                    indexName)
        );
    IF _indexCount &gt; 0
    THEN
        SET
            @_sqlText = CONCAT(' DROP INDEX `IX_',
                            indexName, '` ON `',
                            tableName, '`; '
                );
        PREPARE stmt1
            FROM
            @_sqlText;
        EXECUTE stmt1; DEALLOCATE PREPARE stmt1;
    END IF;
END$$

DELIMITER ;
</code></pre>



  <footer>
  
  





















<script src="//cdn.jsdelivr.net/combine/gh/highlightjs/cdn-release@11.7.0/build/highlight.min.js,npm/@xiee/utils/js/load-highlight.js" defer></script>



  
  <hr>
  <div class="copyright">© <a href="https://mingzaily.com">mingzaily</a> 2019-2024 | <a href="https://github.com/mingzaily">Github</a></div>
  
  </footer>
  </article>
  
  </body>
</html>

